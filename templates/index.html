<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WhatsApp Sender</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>Uploaded Excel Files</h2>
      <p class="small">
        Open any Excel to view preview and edit details on a dedicated page.
      </p>
      <label>
        Upload New Excel (Optional)
        <input
          type="file"
          name="contacts_file"
          id="contacts-file-input"
          accept=".xlsx,.xlsm,.xltx,.xltm"
          form="send-form"
        >
      </label>
      <ul id="history-list" class="history-list">
        {% if uploaded_excel_files %}
          {% for file in uploaded_excel_files %}
            <li class="history-item">
              <div class="history-name">{{ file.display_name }}</div>
              <div class="history-desc">{{ file.description or 'No description yet.' }}</div>
              <div class="history-meta">{{ file.modified_at }} - {{ file.size_label }}</div>
              <a class="history-open" href="/contacts/{{ file.name|urlencode }}">Open</a>
            </li>
          {% endfor %}
        {% else %}
          <li class="history-empty">No Excel files uploaded yet.</li>
        {% endif %}
      </ul>
    </aside>

    <main class="card">
      <header class="header">
        <h1>WhatsApp Sender</h1>
        <p class="hint">
          Enter the phone once. You can type local digits or full country code, and it will be converted to WhatsApp format automatically.
        </p>
        <p class="small">
          Default country code for local numbers: +{{ default_country_code }}
        </p>
      </header>

      <div id="status" class="status hidden"></div>

      <form id="send-form" method="post" enctype="multipart/form-data">
        <label>
          Phone Number
          <input
            type="text"
            name="phone"
            id="phone-input"
            placeholder="81744432 or 96181744432"
          >
        </label>

        <label>
          Message
          <textarea
            name="message"
            id="message-input"
            placeholder="Write text message. If you choose media, this is used as caption."
          >{{- default_message_template -}}</textarea>
        </label>

        <p class="small">
          Use Excel variables inside message like <code>{% raw %}{{name}}{% endraw %}</code> or <code>{% raw %}{{password}}{% endraw %}</code>.
        </p>

        <label>
          Media (Optional)
          <input type="file" name="media" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
        </label>

        <label>
          Select Existing Excel (Optional)
          <select name="existing_contacts_file" id="existing-contacts-select">
            <option value="">-- Select saved Excel file --</option>
            {% for file in uploaded_excel_files %}
              <option value="{{ file.name }}" {% if selected_existing_contacts_file == file.name %}selected{% endif %}>
                {{ file.display_name }} ({{ file.modified_at }})
              </option>
            {% endfor %}
          </select>
        </label>

        <p class="small">
          If both are provided, uploaded Excel is used and also saved in history.
        </p>
        <p class="small">
          Excel must include a column named <strong>NUMBERS</strong>. Other columns can be used as variables.
        </p>

        <button id="send-button" type="submit">Send</button>
      </form>
    </main>
  </div>

  <div id="qr-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="qr-title">
    <div class="modal-card">
      <h2 id="qr-title">WhatsApp Login</h2>
      <p id="qr-message" class="modal-message">Preparing login...</p>
      <div id="qr-loader" class="loader"></div>
      <img id="qr-image" class="qr-image hidden" alt="WhatsApp QR code">
      <div class="modal-actions">
        <button id="close-modal" type="button" class="secondary">Close</button>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/index.js') }}" defer></script>
</body>
</html>
